!function(e,t){for(var i in t)e[i]=t[i]}(window,function(e){var t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(s,n,function(t){return e[t]}.bind(null,n));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t){e.exports=global.window},function(e,t){e.exports=global.window},function(e,t,i){"use strict";i.r(t);var s={};i.r(s),i.d(s,"convertBytesToReadable",function(){return c}),i.d(s,"compareStrings",function(){return d}),i.d(s,"compareNumbers",function(){return u}),i.d(s,"compareDateStrings",function(){return m}),i.d(s,"parseTextFile",function(){return p}),i.d(s,"parseJsonFile",function(){return f}),i.d(s,"parseTextArrayBuffer",function(){return g}),i.d(s,"parseJsonArrayBuffer",function(){return w}),i.d(s,"fileToDataUrl",function(){return y}),i.d(s,"fileToArrayBuffer",function(){return _}),i.d(s,"dataUrlToBlob",function(){return C}),i.d(s,"stringToArrayBuffer",function(){return b}),i.d(s,"copyArrayBuffer",function(){return v}),i.d(s,"getOpt",function(){return S});var n={};i.r(n),i.d(n,"Dialog",function(){return Y}),i.d(n,"ConfirmDialog",function(){return Q});var r={};i.r(r),i.d(r,"Column",function(){return ee}),i.d(r,"Table",function(){return ie});var a={};i.r(a),i.d(a,"Message",function(){return re});var o={};i.r(o),i.d(o,"parseConfigFile",function(){return de}),i.d(o,"updateConfigFile",function(){return ue});var l={};i.r(l),i.d(l,"FileBrowser",function(){return me}),i.d(l,"DialogBrowser",function(){return pe}),i.d(l,"ConfigFileMixin",function(){return fe});let h=["KB","MB","GB","TB"];function c(e){let t=null,i=h.length;for(;!t&&i>0;){let s=e/Math.pow(10,3*i),n=s>10?0:1;if(s>1||0===i){let e=h[i-1];t=`${s.toFixed(n)} ${e}`}i--}return t||`${e} bytes`}function d(e,t){return e.localeCompare(t)}function u(e,t){return e-t}function m(e,t){return new Date(e)-new Date(t)}async function p(e){return await new Promise((t,i)=>{let s=new FileReader;s.onload=(()=>{t(s.result)}),s.onerror=(()=>{i(s.error)}),s.readAsText(e)})}async function f(e){let t=await p(e);try{return JSON.parse(t)}catch(e){throw new Error(`Error reading json file: ${e}.`)}}function g(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function w(e){return JSON.parse(g(e))}async function y(e){return await new Promise((t,i)=>{let s=new FileReader;s.onload=(()=>{t(s.result)}),s.onerror=(()=>{i(s.error)}),s.readAsDataURL(e)})}async function _(e){return await new Promise((t,i)=>{let s=new FileReader;s.onload=(()=>{t(s.result)}),s.onerror=(()=>{i(s.error)}),s.readAsArrayBuffer(e)})}function C(e){let t=e.split(":")[1].split(","),i=t[0],s=t[1],n=i.split(";"),r=n[0]||"text/plain";if(n[1]&&"base64"===n[1]){let e=atob(s);s=new Uint8Array(new ArrayBuffer(e.length));for(let t=0;t<e.length;t++)s[t]=e.charCodeAt(t)}return new Blob([s],{type:r})}function b(e){return Uint8Array.from([...e].map(e=>e.charCodeAt(0))).buffer}function v(e){let t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(new Uint8Array(e)),t}function S(...e){let t=0,i={};for(;t<e.length;){if(e[t].startsWith("-")){let s=e.splice(t,2);i[s[0].substr(1)]=s[1]||{}}t++}return[e,i]}class F extends Error{constructor(e){super(e),this.name=this.constructor.name}}class N{async getRootFileNode(){throw new Error("Not implemented")}async readFileNode(e,t){throw new Error("Not implemented")}async writeFileNode(e,t){throw new Error("Not implemented")}async addFile(e,t,i,s){throw new Error("Not implemented")}async addDirectory(e,t){throw new Error("Not implemented")}async rename(e,t){throw new Error("Not implemented")}async delete(e){throw new Error("Not implemented")}async copy(e,t){throw new Error("Not implemented")}async move(e,t){throw new Error("Not implemented")}async search(e,t){throw new Error("Not implemented")}clone(){throw new Error("Not implemented")}}let D=e=>(class extends e{constructor(...e){super(...e),this.addDirectoryName=".mkdir",this.addFileName=".add",this.renameFileName=".rename",this.deleteFileName=".delete",this.moveFileName=".move",this.searchFileName=".search"}async _getAPIFileNode(e,t){let i=await storage.readFileNode(e),s=(await w(i))[t];if(!s)throw new F(`API file ${t} not found.`);return s}async addFile(e,t,i,s){let n=JSON.stringify({file:t,name:i}),r=await this._getAPIFileNode(e,b(n));return await this.writeFileNode(r.id,data)}async addDirectory(e,t){let i=await this._getAPIFileNode(e,b(this.addDirectoryName));return await this.writeFileNode(i.id,t)}async rename(e,t){let i=new FormData;i.append("id",e),i.append("to",t);let s=JSON.stringify({id:e,to:t}),n=await this.getRootFileNode(),r=await this._getAPIFileNode(n.id,this.renameFileName);await this.writeFileNode(r.id,b(s))}async delete(e){let t=await this.getRootFileNode(),i=await this._getAPIFileNode(t.id,this.deleteFileName);await this.writeFileNode(i.id,b(e))}async copy(e,t){await super.copy(e)}async move(e,t){let i=await this._getAPIFileNode(t,this.moveFileName);await this.writeFileNode(i,b(e))}async search(e,t){let i=await this._getAPIFileNode(fileNodeId,this.searchFileName);return w(await this.readFileNode(i,{query:t}))}});class x extends(D(N)){constructor(e){super(),this._baseUrl=e,this.requestTimeout=10;let t=(new Date).toISOString();this._rootFileNode={id:this._baseUrl,name:"root",url:this._baseUrl,directory:!0,icon:null,size:0,mimeType:"application/json",lastModified:t,created:t}}clone(){let e=new this.constructor(this._baseUrl);return e.changeDirectory(this.path,!0),e}async getRootFileNode(){return this._rootFileNode}async readFileNode(e,t){return t=t||{},await this._ajax(e,t,"GET")}async writeFileNode(e,t){return await this._ajax(e,t,"POST")}async _ajax(e,t,i){return await new Promise((s,n)=>{t=t||{},"GET"!==(i=(i=i||"GET").toUpperCase())&&"DELETE"!==i||(e+=this.constructor.encodeQueryData(t),t=null);let r=new XMLHttpRequest;r.responseType="arraybuffer",r.onreadystatechange=(()=>{if(r.readyState===XMLHttpRequest.DONE)if(0===r.status)n("An error has occurred");else{let e=r.getResponseHeader("content-type");if(r.status>=200&&r.status<400)s(r.response);else{let t=(new TextDecoder).decode(r.response),i=`${r.status} error: `;if("application/json"===e)try{let e=JSON.parse(t);for(let t in e)i+=`${t} - ${e[t]}. `;n(new Error(i))}catch(e){n("Error parsing response.")}else i+=t,n(new Error(i))}}}),r.open(i,e,!0),r.timeout=1e3*this.requestTimeout,r.setRequestHeader("Content-Type","application/json"),this.constructor.configureAjaxRequest(r,i,e,t),r.send(t)})}static configureAjaxRequest(e,t,i,s){this.isCrossDomain(i)||(e.withCredentials=!0,e.setRequestHeader("X-CSRFToken",this.csrfCookie))}static getCookie(e){let t=document.cookie.split(`${e}=`);return t.length>1&&(t=t[1].split(";"))[0]||null}static encodeQueryData(e){let t=[];for(let i in e)e.hasOwnProperty(i)&&t.push(encodeURIComponent(i)+"="+encodeURIComponent(e[i]));return"?"+t.join("&")}static isCrossDomain(e){let t=document.createElement("a");return t.href=e,window.location.protocol+"//"+window.location.host!=t.protocol+"//"+t.host}static get csrfCookie(){return this.getCookie("csrftoken")}}void 0===Object.values&&(Object.values=(e=>Object.keys(e).map(t=>e[t])));class T{constructor(e,t,i){this._name=t,this._mimeType=i,this._created=new Date,this._lastModified=new Date,this.parent=e}static get directory(){return!1}get parent(){return this._parent}set parent(e){this._parent&&this._parent.removeChild(this.name),null!==e&&e.addChild(this),this._parent=e}get mimeType(){return this._mimeType||"application/octet-stream"}get id(){return null===this.parent?"":this.parent.id+"/"+this.name}get name(){return this._name}get icon(){return null}get url(){return""}get created(){return this._created.toISOString()}get lastModified(){return this._lastModified.toISOString()}get fileData(){throw new Error("Not implemented")}get size(){throw new Error("Not implemented")}get children(){throw new Error("Not implemented")}get fileNode(){return{id:this.id,name:this.name,url:this.url,directory:this.constructor.directory,icon:this.icon,size:this.size,mimeType:this.mimeType,lastModified:this.lastModified,created:this.created}}rename(e){this.parent.removeChild(this.name),this._name=e,this.parent.addChild(this.name)}}class O extends T{constructor(e,t,i,s){if(super(e,t,s),!(i instanceof ArrayBuffer))throw new Error(`File data must be an ArrayBuffer not ${typeof i}.`);this._fileData=i}get fileData(){return this._fileData}set fileData(e){this._fileData=e,this._lastModified=new Date}get size(){return this._fileData.size}get lastModified(){return this._lastModified.toISOString()}get children(){return{}}}class E extends T{constructor(e,t){super(e,t,"application/json"),this._children={}}static get directory(){return!0}get fileData(){let e={};for(let t in this._children)e[t]=this._children[t].fileNode;return b(JSON.stringify(e))}get size(){let e=0;for(let t of Object.values(this._children))e+=t.size;return e}get lastModified(){return 0===Object.values(this._children).length?this.created:new Date(Math.max.apply(null,Object.values(this._children).map(function(e){return new Date(e.lastModified)}))).toISOString()}get children(){return this._children}addChild(e){this._children[e.name]=e}removeChild(e){delete this._children[e]}}class j extends N{constructor(){super(),this._root=new E(null,"root")}async getRootFileNode(){return this._root.fileNode}async readFileNode(e,t){return this._getFile(e).fileData}_stringToPathArray(e){return""===(e=e.trim())?[]:e.split("/")}_normalizePath(e){let t=this._stringToPathArray(e),i=[];for(let e of t)""!==e.trim()&&i.push(e.toString());return i.join("/")}_getFile(e){e=this._normalizePath(e);let t=this._stringToPathArray(e),i=this._root,s=0;for(;s<t.length;){let n=t[s];if(n&&void 0===(i=i.children[n]))throw new F(`File not found at ${e}.`);s++}return i}async addFile(e,t,i,s){let n=this._getFile(e);return new O(n,i,t,s).fileNode}async writeFileNode(e,t){let i=this._getFile(e);return i.fileData=t,i.fileNode}async addDirectory(e,t){let i=this._getFile(e);return new E(i,t).fileNode}async rename(e,t){this._getFile(e).rename(t)}async delete(e){let t=this._getFile(e);t.parent.removeChild(t.name)}async copy(e,t){let i=this._getFile(e),s=this._getFile(t);i.directory?new E(s,i.name):new O(s,i.name,v(i.fileData),i.mimeType)}async move(e,t){this._getFile(e).parent=this._getFile(t)}async search(e,t){throw new Error("Not implemented")}clone(){throw new Error("Not implemented")}}function M(e){return new Promise((t,i)=>{e.onsuccess=(e=>{t(e.target.result)}),e.onerror=(e=>{i(e.target.error)})})}class k extends N{constructor(){super();let e=(new Date).toISOString();this._rootFileNode={id:this.constructor.fsRootId,name:"root",url:"",lastModified:e,created:e,directory:!0,icon:null,size:0,mimeType:"application/json"},this._dbPromise=this.getDB()}static get dbName(){return"db"}static get fsRootId(){return"fsRoot"}static get migrations(){return[(e,t)=>{let i=e.createObjectStore("files",{keyPath:"id",autoIncrement:!0});i.createIndex("parentId","parentId",{unique:!1}),i.createIndex("uniqueNameForDirectory",["name","parentId"],{unique:!0})},(e,t)=>{e.deleteObjectStore("files");let i=e.createObjectStore("files",{keyPath:"id",autoIncrement:!0});i.createIndex("parentId","parentId",{unique:!1}),i.createIndex("uniqueNameForDirectory",["name","parentId"],{unique:!0})},(e,t)=>{return M(t.objectStore("files").getAll()).then(e=>{let i=[];for(let s of e)s.file?(s.mimeType=s.type,s.lastModified=s.file.lastModified,s.file=new ArrayBuffer(2)):(s.mimeType="application/json",s.lastModified=s.created),i.push(M(t.objectStore("files").put(s)));return Promise.all(i)})}]}async getDB(){return await new Promise((e,t)=>{let i=this.constructor.migrations.length,s=window.indexedDB.open(this.constructor.dbName,i);s.onsuccess=(t=>{let i=t.target.result;e(i)}),s.onupgradeneeded=(n=>{let r=n.target.result,a=n.target.transaction,o=this.constructor.migrations.slice(n.oldVersion),l=Promise.resolve();for(let e=0;e<o.length;e++){let t=o[e];l=l.then(()=>(console.log(`Running migration for version ${e}.`),t(r,a)||Promise.resolve()))}l=l.catch(e=>{t(`Error updating the database from ${e.oldVersion} to ${i}: ${e}`)}),s.onsuccess=(t=>{l.then(()=>{let i=t.target.result;e(i)})})}),s.onerror=(e=>{t(`Error connecting to the database: ${e.target.error}`)})})}async _fileDataToFileNode(e){let t={id:e.id,name:e.name,icon:null,created:e.created,lastModified:e.lastModified,hidden:e.name.startsWith("."),mimeType:e.mimeType};return e.file?Object.assign(t,{directory:!1,url:await y(new Blob([e.file])),size:e.file.size}):Object.assign(t,{directory:!0,url:"",size:0}),t}async _createDirectoryArrayBuffer(e){let t=(await this._dbPromise).transaction("files");return await new Promise((i,s)=>{let n=[],r=t.objectStore("files").index("parentId").openCursor(e);r.onerror=(()=>{s(`Could not get files contained in directory with id ${e}.`)}),r.onsuccess=(e=>{let t=e.target.result;if(t){t.continue();let e=t.value;n.push(this._fileDataToFileNode(e))}else Promise.all(n).then(e=>{let t={};for(let i of e)i.id=i.id.toString(),t[i.name]=i;let s=b(JSON.stringify(t));i(s)}).catch(s)})})}async getRootFileNode(){return this._rootFileNode}async readFileNode(e,t){if(e===(await this.getRootFileNode()).id)return this._createDirectoryArrayBuffer(e);{let t,i=(await this._dbPromise).transaction("files");try{t=await M(i.objectStore("files").get(parseInt(e)))}catch(t){throw new F(`Could not find file with id ${e}.`)}return null===t.file?this._createDirectoryArrayBuffer(e):t.file}}async writeFileNode(e,t){let i,s=(await this._dbPromise).transaction("files","readwrite");try{i=await M(s.objectStore("files").get(parseInt(e)))}catch(t){new F(`Could not find file with id ${e}.`)}i.file=t,i=await this._validate(i);try{await M(s.objectStore("files").put(i))}catch(e){throw new Error(`Could not update file ${i.name}`)}return i.file}async _validate(e){if(e.name=new String(e.name),null!==e.file&&!(e.file instanceof ArrayBuffer))throw new Error(`Invalid file data. Must be ArrayBuffer, not ${typeof e.file}`);let t=await this.getRootFileNode();if(e.parentId!==t.id){let t=(await this._dbPromise).transaction("files"),i=await M(t.objectStore("files").get(parseInt(e.parentId)));if(!i)throw new F(`Parent does not exist with id ${e.parentId}`);if(i.file)throw new Error(`Parent with id ${e.parentId} is not a directory.`)}return e}async _addItem(e,t,i,s){i=i||null,s=s||"application/octet-stream",null===i&&(s="application/json");let n=(new Date).toISOString(),r={parentId:e,name:t,file:i,mimeType:s,lastModified:n,created:n};r=await this._validate(r);let a=(await this._dbPromise).transaction("files","readwrite");try{let e=await M(a.objectStore("files").add(r));r.id=e.toString()}catch(e){throw new Error(`Could not add file ${t}.`)}return this._fileDataToFileNode(r)}async addFile(e,t,i,s){return await this._addItem(e,i,t,s)}async addDirectory(e,t){return await this._addItem(e,t)}async rename(e,t){let i,s=(await this._dbPromise).transaction("files","readwrite");try{i=await M(s.objectStore("files").get(parseInt(e)))}catch(t){throw new F(`Could not find file with id ${e}.`)}i.name=t;try{await M(s.objectStore("files").put(i))}catch(t){throw new Error(`Could not update file with id ${e}`)}return i.file}async delete(e){let t=(await this._dbPromise).transaction("files","readwrite");try{await M(t.objectStore("files").delete(parseInt(e)))}catch(t){throw new Error(`Could not delete file with id ${e}.`)}}async copy(e,t){let i,s=(await this._dbPromise).transaction("files","readwrite");try{i=await M(s.objectStore("files").get(parseInt(e)))}catch(t){throw new F(`Could not find file with id ${e}.`)}i.parentId=t,delete i.id;try{await M(s.objectStore("files").put(i))}catch(e){throw new Error(`Could not copy to file with id ${t}`)}return i.file}async move(e,t){let i,s=(await this._dbPromise).transaction("files","readwrite");try{i=await M(s.objectStore("files").get(parseInt(e)))}catch(e){throw new F(`Could not find file with id ${id}.`)}i.parentId=t;try{await M(s.objectStore("files").put(i))}catch(e){throw new Error(`Could not move to file with id ${t}`)}return i.file}async search(e,t){throw new Error("Not implemented")}clone(){throw new Error("Not implemented")}}var P=i(0),A=i(1);function R(e){return async(...t)=>await new Promise((i,s)=>{t.push((e,t)=>{e?s(e):i(t)}),e(...t)})}class I extends N{constructor(e){super(),this.rootPath=e||"/",this.stat=R(P.stat),this.readFile=R(P.readFile),this.writeFile=R(P.writeFile),this.readdir=R(P.readdir),this.appendFile=R(P.appendFile),this.mkdir=R(P.mkdir),this.fsrename=R(P.rename),this.unlink=R(P.unlink)}async _getFileNodeFromFSPath(e){let t=await this.stat(e),i=A.basename(e);return{id:e,name:i,directory:t.isDirectory(),mimeType:"application/octet-stream",size:t.size,created:t.birthtime.toISOString(),lastModified:t.ctime.toISOString(),icon:null,hidden:i.startsWith(".")}}async getRootFileNode(){return await this._getFileNodeFromFSPath(this.rootPath)}async readFileNode(e,t){if((await this._getFileNodeFromFSPath(e)).directory){let t={},i=await this.readdir(e);for(let s of i)t[s]=await this._getFileNodeFromFSPath(A.join(e,s));return b(JSON.stringify(t))}return(await this.readFile(e)).buffer}async writeFileNode(e,t){await this.writeFile(e,t)}async addFile(e,t,i,s){if(!(t instanceof ArrayBuffer))throw new Error(`File data must be ArrayBuffer not ${typeof t}.`);let n=A.join(e,i);return await this.appendFile(n,t),await this._getFileNodeFromFSPath(n)}async addDirectory(e,t){let i=A.join(e,t);return await this.mkdir(i,null),await this._getFileNodeFromFSPath(i)}async rename(e,t){let i=A.dirname(e);await this.fsrename(e,A.join(i,t))}async delete(e){await this.unlink(e)}async copy(e){throw new Error("Not implemented")}async move(e){throw new Error("Not implemented")}async search(e){throw new Error("Not implemented")}clone(){throw new Error("Not implemented")}}var L=function(){function e(e,t){if(!n[e]){n[e]={};for(var i=0;i<e.length;i++)n[e][e.charAt(i)]=i}return n[e][t]}var t=String.fromCharCode,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={},r={compressToBase64:function(e){if(null==e)return"";var t=r._compress(e,6,function(e){return i.charAt(e)});switch(t.length%4){default:case 0:return t;case 1:return t+"===";case 2:return t+"==";case 3:return t+"="}},decompressFromBase64:function(t){return null==t?"":""==t?null:r._decompress(t.length,32,function(s){return e(i,t.charAt(s))})},compressToUTF16:function(e){return null==e?"":r._compress(e,15,function(e){return t(e+32)})+" "},decompressFromUTF16:function(e){return null==e?"":""==e?null:r._decompress(e.length,16384,function(t){return e.charCodeAt(t)-32})},compressToUint8Array:function(e){for(var t=r.compress(e),i=new Uint8Array(2*t.length),s=0,n=t.length;n>s;s++){var a=t.charCodeAt(s);i[2*s]=a>>>8,i[2*s+1]=a%256}return i},decompressFromUint8Array:function(e){if(null===e||void 0===e)return r.decompress(e);for(var i=new Array(e.length/2),s=0,n=i.length;n>s;s++)i[s]=256*e[2*s]+e[2*s+1];var a=[];return i.forEach(function(e){a.push(t(e))}),r.decompress(a.join(""))},compressToEncodedURIComponent:function(e){return null==e?"":r._compress(e,6,function(e){return s.charAt(e)})},decompressFromEncodedURIComponent:function(t){return null==t?"":""==t?null:(t=t.replace(/ /g,"+"),r._decompress(t.length,32,function(i){return e(s,t.charAt(i))}))},compress:function(e){return r._compress(e,16,function(e){return t(e)})},_compress:function(e,t,i){if(null==e)return"";var s,n,r,a={},o={},l="",h="",c="",d=2,u=3,m=2,p=[],f=0,g=0;for(r=0;r<e.length;r+=1)if(l=e.charAt(r),Object.prototype.hasOwnProperty.call(a,l)||(a[l]=u++,o[l]=!0),h=c+l,Object.prototype.hasOwnProperty.call(a,h))c=h;else{if(Object.prototype.hasOwnProperty.call(o,c)){if(c.charCodeAt(0)<256){for(s=0;m>s;s++)f<<=1,g==t-1?(g=0,p.push(i(f)),f=0):g++;for(n=c.charCodeAt(0),s=0;8>s;s++)f=f<<1|1&n,g==t-1?(g=0,p.push(i(f)),f=0):g++,n>>=1}else{for(n=1,s=0;m>s;s++)f=f<<1|n,g==t-1?(g=0,p.push(i(f)),f=0):g++,n=0;for(n=c.charCodeAt(0),s=0;16>s;s++)f=f<<1|1&n,g==t-1?(g=0,p.push(i(f)),f=0):g++,n>>=1}0==--d&&(d=Math.pow(2,m),m++),delete o[c]}else for(n=a[c],s=0;m>s;s++)f=f<<1|1&n,g==t-1?(g=0,p.push(i(f)),f=0):g++,n>>=1;0==--d&&(d=Math.pow(2,m),m++),a[h]=u++,c=String(l)}if(""!==c){if(Object.prototype.hasOwnProperty.call(o,c)){if(c.charCodeAt(0)<256){for(s=0;m>s;s++)f<<=1,g==t-1?(g=0,p.push(i(f)),f=0):g++;for(n=c.charCodeAt(0),s=0;8>s;s++)f=f<<1|1&n,g==t-1?(g=0,p.push(i(f)),f=0):g++,n>>=1}else{for(n=1,s=0;m>s;s++)f=f<<1|n,g==t-1?(g=0,p.push(i(f)),f=0):g++,n=0;for(n=c.charCodeAt(0),s=0;16>s;s++)f=f<<1|1&n,g==t-1?(g=0,p.push(i(f)),f=0):g++,n>>=1}0==--d&&(d=Math.pow(2,m),m++),delete o[c]}else for(n=a[c],s=0;m>s;s++)f=f<<1|1&n,g==t-1?(g=0,p.push(i(f)),f=0):g++,n>>=1;0==--d&&(d=Math.pow(2,m),m++)}for(n=2,s=0;m>s;s++)f=f<<1|1&n,g==t-1?(g=0,p.push(i(f)),f=0):g++,n>>=1;for(;;){if(f<<=1,g==t-1){p.push(i(f));break}g++}return p.join("")},decompress:function(e){return null==e?"":""==e?null:r._decompress(e.length,32768,function(t){return e.charCodeAt(t)})},_decompress:function(e,i,s){var n,r,a,o,l,h,c,d=[],u=4,m=4,p=3,f="",g=[],w={val:s(0),position:i,index:1};for(n=0;3>n;n+=1)d[n]=n;for(a=0,l=Math.pow(2,2),h=1;h!=l;)o=w.val&w.position,w.position>>=1,0==w.position&&(w.position=i,w.val=s(w.index++)),a|=(o>0?1:0)*h,h<<=1;switch(a){case 0:for(a=0,l=Math.pow(2,8),h=1;h!=l;)o=w.val&w.position,w.position>>=1,0==w.position&&(w.position=i,w.val=s(w.index++)),a|=(o>0?1:0)*h,h<<=1;c=t(a);break;case 1:for(a=0,l=Math.pow(2,16),h=1;h!=l;)o=w.val&w.position,w.position>>=1,0==w.position&&(w.position=i,w.val=s(w.index++)),a|=(o>0?1:0)*h,h<<=1;c=t(a);break;case 2:return""}for(d[3]=c,r=c,g.push(c);;){if(w.index>e)return"";for(a=0,l=Math.pow(2,p),h=1;h!=l;)o=w.val&w.position,w.position>>=1,0==w.position&&(w.position=i,w.val=s(w.index++)),a|=(o>0?1:0)*h,h<<=1;switch(c=a){case 0:for(a=0,l=Math.pow(2,8),h=1;h!=l;)o=w.val&w.position,w.position>>=1,0==w.position&&(w.position=i,w.val=s(w.index++)),a|=(o>0?1:0)*h,h<<=1;d[m++]=t(a),c=m-1,u--;break;case 1:for(a=0,l=Math.pow(2,16),h=1;h!=l;)o=w.val&w.position,w.position>>=1,0==w.position&&(w.position=i,w.val=s(w.index++)),a|=(o>0?1:0)*h,h<<=1;d[m++]=t(a),c=m-1,u--;break;case 2:return g.join("")}if(0==u&&(u=Math.pow(2,p),p++),d[c])f=d[c];else{if(c!==m)return null;f=r+r.charAt(0)}g.push(f),d[m++]=r+f.charAt(0),r=f,0==--u&&(u=Math.pow(2,p),p++)}}};return r}();class ${constructor(e,t,i,s){this._fileStorage=e,this._fileNode=t,this._name=i,this._parent=s,this._filePromiseCache=null}get fileStorage(){return this._fileStorage}get fileNode(){return this._fileNode}get id(){return this._fileNode.id}get name(){return this._name}get path(){return null===this.parent?[]:this.parent.path.concat([this.name])}get url(){return this._fileNode.url}get directory(){return this._fileNode.directory}get icon(){return this._fileNode.icon}get mimeType(){return this._fileNode.mimeType}get size(){return this._fileNode.size}get lastModified(){return this._fileNode.lastModified}get created(){return this._fileNode.created}get parent(){return this._parent}clearCache(){this._filePromiseCache=null;let e=this.parent;e&&e.clearCache()}async read(e){return null===this._filePromiseCache&&(this._filePromiseCache=this.fileStorage.readFileNode(this.id,e)),await this._filePromiseCache}async write(e){return this.clearCache(),await this.fileStorage.writeFileNode(this.id,e)}async readText(e){return g(await this.read(e))}async readJSON(e){return w(await this.read(e))}async rename(e){this.clearCache(),await this.fileStorage.rename(this.id,e),this._fileNode.name=e}async delete(){return this.clearCache(),await this.fileStorage.delete(this.id)}async search(e){let t=[],i=await this.fileStorage.search(this.id,e);for(let e of i)t.push(new $(this.fileStorage,e,e.name,this));return t}toString(){return`/${this.path.join("/")}`}}class B extends ${constructor(e,t,i){super(e.fileStorage,e.fileNode,t,i),this._fileObject=e}get mimeType(){return"inode/symlink"}async read(e){return b(JSON.stringify(this._fileObject.path))}}class z{constructor(e){this._rootFileStorage=e,this._rootFileObject=null}async getRootFileObject(){if(null===this._rootFileObject){let e=await this._rootFileStorage.getRootFileNode();this._rootFileObject=new $(this._rootFileStorage,e,this.constructor.rootFileName,null)}return this._rootFileObject}static get rootFileName(){return"root"}async getFileObject(e){if(0===e.length)return await this.getRootFileObject();let t=e[e.length-1],i=e.slice(0,e.length-1),s=(await this.listDirectory(i))[t];if(!s)throw new F(`File ${t} not found.`);return s}async getChildren(e){let t=await e.readJSON(),i={};for(let s in t)i[s]=new $(e.fileStorage,t[s],s,e);return i}async listDirectory(e){let t=await this.getFileObject(e);return await this.getChildren(t)}async read(e,t){let i=await this.getFileObject(e);return await i.read(t)}async write(e,t){let i=await this.getFileObject(e);return await i.write(t)}async addFile(e,t,i){let s=await this.getFileObject(e),n=await s.fileStorage.addFile(s.id,t,i);return new $(s.fileStorage,n,i,s)}async addDirectory(e,t){let i=await this.getFileObject(e),s=await i.fileStorage.addDirectory(i.id,t);return new $(i.fileStorage,s,t,i)}async copy(e,t){let i=await this.getFileObject(e);if(t.fileStorage===i.fileStorage)await t.fileStorage.copy(t.id,i.id);else{let e=await this.targetFileObject.fileStorage.readFileNode(this.targetFileObject.id);await this.targetFileObject.fileStorage.addFile(this.targetFileObject.id,e,t.name)}}async move(e,t){let i=await this.getFileObject(e);if(t.fileStorage!==i.fileStorage)throw new Error("Cannot move file across file systems.");await t.fileStorage.move(t.id,i.id)}async search(e,t){let i=await this.getFileObject(e);return await i.search(t)}clone(){return new this.constructor(this._rootFileStorage)}}let H=e=>(class extends e{constructor(...e){super(...e),this._pathCache={}}async getFileObject(e){let t=JSON.stringify(e),i=this._pathCache[t];return i||(i=await super.getFileObject(e),this._pathCache[t]=i),i}async refresh(){this._pathCache={},await super.refresh()}}),J=e=>(e=H(e),class extends e{constructor(...e){super(...e),this._currentDirectory=null,this._data={},this._path=[],this._lastCall=null,this._compressor=L,this._trackState=!1,this.onDataChanged=null,this.onPathChanged=null,this.addFile=this.waitOn(this.refreshAfter(this.addFile)),this.addDirectory=this.waitOn(this.refreshAfter(this.addDirectory)),this.copy=this.waitOn(this.refreshAfter(this.copy)),this.move=this.waitOn(this.refreshAfter(this.move)),this.search=this.waitOn(this.search),this.changeDirectory=this.waitFor(this.waitOn(this.changeDirectory)),window.addEventListener("hashchange",this.waitOn(e=>{this._trackState&&(this._hashState=location.hash)})),this.changeDirectory(this.path)}get data(){return this._data}get path(){return this._path}get _hashState(){return this._compressor.compressToEncodedURIComponent(JSON.stringify(this.path))}set _hashState(e){if(e.startsWith("#")&&(e=e.slice(1,e.length)),e!==this._hashState){let t;try{t=JSON.parse(this._compressor.decompressFromEncodedURIComponent(e))}catch(t){console.log(`Invalid hash state ${e}`)}t&&this.changeDirectory(t)}}set trackState(e){this._trackState=Boolean(e),this._trackState&&(this._hashState=location.hash)}clone(){let e=super.clone();return e._path=this._path,e._currentDirectory=this._currentDirectory,e._data=Object.assign({},this._data),e.trackState=!1,e}async changeDirectory(e){this._path=e.slice(),this._currentDirectory=await this.getFileObject(e),await this.refresh(),this.onPathChanged&&this.onPathChanged(this.path),this._trackState&&(window.location.hash=this._hashState)}async refresh(){this._rootFileObject=null,null!==this._currentDirectory&&this._currentDirectory.clearCache(),this._data=await this.listDirectory(this.path),this.onDataChanged&&this.onDataChanged(this.data)}refreshAfter(e){return async(...t)=>{let i=await e.bind(this)(...t);return await this.refresh(),i}}waitFor(e){return async(...t)=>(this._lastCall=e.bind(this)(...t),await this._lastCall)}waitOn(e){return async(...t)=>{null===this._lastCall&&(this._lastCall=Promise.resolve());try{await this._lastCall}catch(e){this._lastCall=null}return await e.bind(this)(...t)}}}),W=e=>(class extends e{constructor(...e){super(...e)}async changeDirectory(e){let t=await this.getFileObject(e);"inode/symlink"===t.mimeType&&(e=await t.readJSON()),await super.changeDirectory(e)}async getChildren(e){let t=await super.getChildren(e);return t["."]=new B(e,".",e),e.parent&&(t[".."]=new B(e.parent,"..",e)),t}async listDirectory(e){let t=await this.getFileObject(e);return"inode/symlink"===t.mimeType&&(e=await t.readJSON(),t=await this.getFileObject(e)),await this.getChildren(t)}}),U=e=>(class extends e{constructor(...e){super(...e),this._mounts=[]}mount(e,t,i){if(!i)throw new Error("Mount must have a name.");this._mounts.push({fileObject:e,fileStorage:t,name:i})}async getChildren(e){let t=await super.getChildren(e);for(let i of this._mounts)if(i.fileObject.fileStorage===e.fileStorage&&i.fileObject.id===e.id){let s=await i.fileStorage.getRootFileNode();t[i.name]=new $(i.fileStorage,s,i.name,e)}return t}clone(){let e=super.clone();for(let t of this._mounts)e.mount(t.fileObject,t.fileStorage,t.name);return e}});const G=Object.getPrototypeOf(async function(){}).constructor;let q=e=>(class extends e{constructor(...e){super(...e),this.waitOn&&(this.import=this.waitOn(this.import)),this._executablePath=[["bin"]]}get executablePath(){return this._executablePath}set executablePath(e){this._executablePath=e}async exec(e,...t){let i,s=`${e}.js`,n=this.executablePath.slice();for(;void 0===i&&n.length>0;){let e=n.shift();try{i=await this.import(e.concat([s]),"main")}catch(e){if(!(e instanceof F))throw e}}if(void 0===i)throw new F(`No file ${s} in path.`);return await i.bind(this)(...t)}async execFileObject(e,...t){let i=await this.importFromFileObject(e,"main");return await i.bind(this)(...t)}async import(e,t){let i=await this.getFileObject(e);return await this.importFromFileObject(i,t)}async importFromFileObject(e,t){let i=await e.readText();try{let s=new G(`${i};return ${t};`);return await s.bind(this)()}catch(t){throw new Error(`Error importing file ${e}: ${t}`)}}});class V extends(q(W(U(J(z))))){}class K{constructor(){this.render(),this._className=null}static get type(){return"div"}get element(){return this._element}get className(){return this._className}get flatChildren(){return this.element.getElementsByTagName("*")}set className(e){this.element.classList.remove(this.className),this.element.classList.add(e),this._className=e}removeChildren(){for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild)}render(){this._element||(this._element=document.createElement(this.constructor.type)),this.removeChildren()}}let X=e=>(class extends e{constructor(...e){super(...e),this._dragOverClass="dragover",this._pendingActionClass="pending-action",this._counterSet=new Set,new MutationObserver(e=>{for(let t of e)t.removedNodes.length>0&&this.handleChildrenRemove(t.removedNodes)}).observe(this.element,{childList:!0,subtree:!0}),this.onDrop=null,this.onDragEnter=null,this.onDragLeave=null,this.dragOverActions=[],this.dragOverDelay=2e3,this._timeOuts=[],this.element.ondragover=this.handleDragOver.bind(this),this.element.ondragenter=this.handleDragEnter.bind(this),this.element.ondragleave=this.handleDragLeave.bind(this),this.element.ondrop=this.handleDrop.bind(this)}get dragOverClass(){return this._dragOverClass}get isOver(){return this.element.classList.contains(this._dragOverClass)}set dragOverClass(e){this.isOver&&(this.element.classList.remove(this._dragOverClass),this.element.classList.add(e)),this._dragOverClass=e}addDragoverAction(e){this.dragOverActions.push(e)}handleDragOver(e){e.preventDefault()}handleDragEnter(e){e.preventDefault(),0===this._counterSet.size&&(this.element.classList.add(this._dragOverClass),this.setTimeouts(),this.onDragEnter&&this.onDragEnter(e)),this._counterSet.add(e.target)}handleDragLeave(e){e.preventDefault(),this._counterSet.delete(e.target),0===this._counterSet.size&&(this.element.classList.remove(this._dragOverClass),this.clearTimeOuts(),this.onDragLeave&&this.onDragLeave(e))}handleDrop(e){e.preventDefault(),this._counterSet=new Set,this.element.classList.remove(this._dragOverClass),this.clearTimeOuts(),this.onDrop&&this.onDrop(e)}handleChildrenRemove(e){for(let t of e){this._counterSet.delete(t);for(let e of t.querySelectorAll("*"))this._counterSet.delete(e)}}setTimeouts(){if(this.dragOverActions.length>0){for(let e of this.dragOverActions){let t=window.setTimeout(()=>{e()},this.dragOverDelay);this._timeOuts.push(t)}this.element.classList.add(this._pendingActionClass)}}clearTimeOuts(){this.element.classList.remove(this._pendingActionClass);for(let e of this._timeOuts)window.clearTimeout(e);this._timeOuts=[]}}),Z=e=>(class extends e{constructor(...e){super(...e),this._draggingClass="dragging",this.onDragStart=null,this.onDragEnd=null,this.element.draggable=!0,this.element.ondragstart=this.handleDragStart.bind(this),this.element.ondragend=this.handleDragEnd.bind(this)}get draggingClass(){return this._draggingClass}handleDragStart(e){this.element.classList.add(this.draggingClass),this.onDragStart&&this.onDragStart(e)}handleDragEnd(e){this.element.classList.remove(this.draggingClass),this.onDragEnd&&this.onDragEnd(e)}});class Y extends K{constructor(e){super(),this.parent=e||null,this.name="",this._children=new Set,this._body=document.getElementsByTagName("body")[0],this._body.appendChild(this.element),this.className="dialog",this._itemClass="dialog-item",this._position=null,this._fullScreen=!1,this.onShow=null,this.onClose=null,this.onRemove=null,this._clickListener=(e=>{if(!e.defaultPrevented){let t;if(e.path)t=new Set(e.path);else{t=new Set;let i=e.target;for(;i;)t.add(i),i=i.parentElement}let i=t.has(this._element),s=!1;for(let e of this.flatChildren)t.has(e._element)&&(s=!0);i||s||this.close()}}),this.center(),this.items=[]}get children(){return this._children}get flatChildren(){let e=new Set;for(let t of this._children){e.add(t);for(let i of t.flatChildren)e.add(i)}return e}set name(e){this._nameElement.innerText=e}set items(e){for(;this._itemElement.firstChild;)this._itemElement.removeChild(this._itemElement.firstChild);let t=document.createDocumentFragment();for(let i of e)i.classList.add(this._itemClass),t.appendChild(i);this._itemElement.appendChild(t)}set parent(e){if(null===e)this._parent&&this._parent.children.remove(this),this._parent=null;else{if(!parent instanceof Y)throw TypeError("Parent of Dialog must be a Dialog instance.");e.children.add(this)}}render(){super.render(),this._element.style.position="absolute",this._element.style.display="none",this._headerElement=document.createElement("div"),this._headerElement.className="header",this._nameElement=document.createElement("span"),this._nameElement.className="name";let e=document.createElement("div");e.className="dialog-button expand",e.onmousedown=(e=>{e.stopPropagation(),e.preventDefault()}),e.onclick=(e=>{e.stopPropagation(),e.preventDefault(),this._fullScreen?this.center():this.expand()});let t=document.createElement("div");t.className="dialog-button delete",t.onmousedown=(e=>{e.stopPropagation(),e.preventDefault()}),t.onclick=(e=>{e.stopPropagation(),e.preventDefault(),this.close()}),this._headerElement.appendChild(this._nameElement),this._headerElement.appendChild(t),this._headerElement.appendChild(e),this._headerElement.onmousedown=(e=>{e.preventDefault(),this.startDrag()}),this._itemElement=document.createElement("div"),this._itemElement.className="items",this._element.appendChild(this._headerElement),this._element.appendChild(this._itemElement)}show(){this.onShow&&this.onShow(this),this._element.style.display="block",document.addEventListener("click",this._clickListener)}close(){for(let e of this._children)e.close();this.onClose&&this.onClose(this),this._element.style.display="none",document.removeEventListener("click",this._clickListener)}remove(){for(let e of this._children)e.remove();this.onRemove&&this.onRemove(this),this._element.parentElement&&this._element.parentElement.removeChild(this._element),document.removeEventListener("click",this._clickListener)}move(e,t){this._element.style.position="absolute",this._element.style.top=`${t}px`,this._element.style.left=`${e}px`,this._element.style.transform=null,this._position=[e,t],this._fullScreen=!1}center(){this._element.style.position="fixed",this._element.style.top="50%",this._element.style.left="50%",this._element.style.width=null,this._element.style.height=null,this._element.style.transform="translate(-50%, -50%)";let e=this._element.getBoundingClientRect(),t=document.documentElement.scrollLeft,i=document.documentElement.scrollTop;this._position=[e.left+t,e.bottom+i],this._fullScreen=!1}expand(){this._element.style.position="fixed",this._element.style.transform=null,this._element.style.top="0%",this._element.style.left="0%",this._element.style.width="100%",this._element.style.height="100%",this._fullScreen=!0}startDrag(){document.onmousemove=(e=>{let t=document.documentElement.scrollLeft,i=document.documentElement.scrollTop;this.move(t+e.clientX,i+e.clientY)}),document.onmouseup=this.stopDrag.bind(this)}stopDrag(){document.onmousemove=null,document.onmouseup=null}}class Q extends Y{constructor(e){super(e),this._confirmButton=document.createElement("div"),this._confirmButton.innerText="Yes",this._confirmButton.onclick=this._onConfirmed.bind(this),this._confirmButton.className="button",this.element.appendChild(this._confirmButton),this.onConfirmed=null}set confirmationText(e){this._confirmButton.innerText=e}set disabled(e){this._confirmButton.disabled=e}_onConfirmed(e){this.close(),this.onConfirmed&&this.onConfirmed(e)}}class ee extends K{constructor(e,t,i,s,n){super(),this._name=e,this.rowRenderer=t,this.ascendingSortClass="asc",this.descendingSortClass="dsc",this.className="column-header",this.itemClass="column-row",this._sortCompare=i||null,this.onWidthChange=null,this.onVisibilityChange=null,this.onSort=null,this._visible=void 0===n||n,this.width=s||1,this._renderHeader()}static get type(){return"div"}get name(){return this._name}get width(){return this._width}get sortCompare(){return this._sortCompare}get ascending(){return this.element.classList.contains(this.ascendingSortClass)}get descending(){return this.element.classList.contains(this.descendingSortClass)}get visible(){return this._visible}set width(e){this._width=e,this._element.style.width=this._width,this.onWidthChange&&this.onWidthChange(this._width)}set visible(e){let t=this._visible;this._visible=Boolean(e),t!==this._visible&&this.onVisibilityChange&&this.onVisibilityChange(this._visible)}clone(){return new this.constructor(this.name,this.rowRenderer,this.sortCompare,this.width,this.visible)}_renderHeader(){if(this.element.classList.add(this.itemClass),this.element.style.flex=`${this.width}`,this.element.style.padding="0",this.element.style.height="100%",this.removeChildren(),this.sortCompare){let e=document.createElement("a");e.setAttribute("href","#"),e.onclick=(e=>{e.preventDefault(),this.toggleSort()}),e.innerText=this._name,this.element.appendChild(e)}else{let e=document.createElement("span");e.innerText=this._name,this.element.appendChild(e)}}renderRow(e){let t=document.createElement("div");return t.classList.add(this.itemClass),t.style.flex=`${this.width}`,t.style.padding="0",t.style.height="100%",this.rowRenderer(t,e),t}sortRows(e){this.ascending?e.sort((e,t)=>this.sortCompare(e.data,t.data)):this.descending&&e.sort((e,t)=>this.sortCompare(t.data,e.data))}toggleSort(){this.ascending?(this.element.classList.remove(this.ascendingSortClass),this.element.classList.add(this.descendingSortClass)):(this.element.classList.remove(this.descendingSortClass),this.element.classList.add(this.ascendingSortClass)),this.onSort&&this.onSort(this)}clearSort(){this.element.classList.remove(this.ascendingSortClass),this.element.classList.remove(this.descendingSortClass)}}class te extends(Z(X(K))){constructor(e,t){super(),this.data=e||{},this.columns=t||[],this.className="row",this.hidden=!1,this.onClick=null,this.onDblClick=null,this.render()}static get type(){return"div"}static get dataTransferType(){return"text/table-rows"}get data(){return this._data||{}}get columns(){return this._columns||[]}get hidden(){return this._hidden}set data(e){this._data=e,this.render()}set columns(e){this._columns=e,this.render()}set hidden(e){this._hidden=e}render(){super.render(),this.element.style.display="flex";for(let e of this.columns)if(e.visible){let t=e.renderRow(this.data);this.element.appendChild(t)}return this.element.onclick=(e=>this.onClick&&this.onClick(this,e)),this.element.ondblclick=(e=>this.onDblClick&&this.onDblClick(this,e)),this.element}}class ie extends(X(K)){constructor(e,t){super(),this.header=document.createElement("div"),this.body=document.createElement("div"),this._element.appendChild(this.header),this._element.appendChild(this.body),this.className="table",this._headerClassName="header",this._bodyClassName="body",this._rowClassName="row",this._selectedRowClassName="selected",this.header.className=this._headerClassName,this.body.className=this._bodyClassName,this.onRowClick=null,this.onRowDblClick=null,this.onContextMenu=null,this.onColumnsChanged=null,this.onRowsChanged=null,this.onDataChanged=null,this.onSelectionChanged=null,this._selectMultiple=t||!1,this._columns=[],this._selectedRows=new Set,this._rows=[],this._showHidden=!1,this.contextMenu=null,this._defaultSortFunc=null,this.renderHeader(),e&&(this.columns=e)}static get type(){return"div"}static get rowClass(){return te}get rows(){return this._rows.slice()}get columns(){return this._columns}get defaultSortFunc(){return this._defaultSortFunc}get selectedData(){let e=new Set;for(let t of this._selectedRows)e.add(t.data);return e}get selectedRows(){return new Set(this._selectedRows)}get showHidden(){return this._showHidden}get visibleColumnsDialog(){this._columnsDialog||(this._columnsDialog=new Y,this._columnsDialog.name="Columns");let e=[];for(let t of this.columns){let i=document.createElement("div"),s=document.createElement("span"),n=document.createElement("input");n.type="checkbox",n.checked=t.visible,s.innerText=t.name,n.onchange=(()=>{t.visible=n.checked}),i.appendChild(s),i.appendChild(n),e.push(i)}return this._columnsDialog.items=e,this._columnsDialog}set defaultSortFunc(e){this._defaultSortFunc=e}set rowClassName(e){if(this._rowClassName)for(let t of this._rows)t.classList.remove(e);if(e)for(let t of this._rows)t.classList.add(e);this._rowClassName=e}set selectedRowClass(e){if(this._selectedRowClassName)for(let e of this._selectedRows)e.element.classList.remove(this._selectedRowClassName);if(e)for(let t of this._selectedRows)t.element.classList.add(e);this._selectedRowClassName=e}set selectMultiple(e){this._selectMultiple=e,this.toggleRowSelection(null)}set selectedRows(e){let t=new Set(this._selectedRows);this._selectedRows=new Set(e),this._onSelectedRowsChange(this._selectedRows,t)}set showHidden(e){(e=Boolean(e))!==this._showHidden&&(this._showHidden=e,this.renderRows())}set columns(e){this._columns=e,this.renderHeader();for(let e of this._rows)e.columns=this._columns;for(let e of this._columns)e.onWidthChange=e.onVisibilityChange=(e=>{this.renderHeader();for(let e of this._rows)e.render()}),e.onSort=(e=>{for(let t of this._columns)t!==e&&t.clearSort();e.sortRows(this._rows),this.renderRows()});this.onColumnsChanged&&this.onColumnsChanged(e)}set data(e){for(let e of this._columns)e.clearSort();this._defaultSortFunc&&e.sort(this._defaultSortFunc),this.addRows(e),this.onDataChanged&&this.onDataChanged(e)}clone(){let e=[];for(let t of this._columns)e.push(t.clone());return new this.constructor(e,this._selectMultiple)}_onRowClick(e,t){if(this.onRowClick&&this.onRowClick(e,t),!t.defaultPrevented){let i,s;this._selectMultiple?t.shiftKey?(i=!0,s=!0):t.ctrlKey||t.metaKey?(i=!1,s=!0):(i=!1,s=!1):(i=!1,s=!1),this.toggleRowSelection(e,s,i)}return!0}_onRowDblClick(e,t){this.onRowDblClick&&this.onRowDblClick(e,t)}_onRowDrag(e,t){this._selectedRows.has(e)||this._onRowClick(e,t),t.dataTransfer.setData(ie.dataTransferType,JSON.stringify(Array.from(this.selectedData))),t.dataTransfer.dropEffect="move"}_onSelectedRowsChange(e,t){let i=[...e].filter(e=>!t.has(e)),s=[...t].filter(t=>!e.has(t)),n=i.length>0||s.length>0;for(let e of s)e.element.classList.remove(this._selectedRowClassName);for(let e of i)e.element.classList.add(this._selectedRowClassName);n&&this.onSelectionChanged&&this.onSelectionChanged(e,i,s)}renderHeader(){for(;this.header.firstChild;)this.header.removeChild(this.header.firstChild);let e=document.createElement("div");e.className=this._rowClassName,e.style.display="flex";for(let t of this._columns)t.visible&&e.appendChild(t.element);this.header.appendChild(e)}addRows(e){this._rows=[];for(let t of e){let e=new this.constructor.rowClass(t,this._columns);e.onClick=this._onRowClick.bind(this),e.onDblClick=this._onRowDblClick.bind(this),e.element.oncontextmenu=(t=>(this._selectedRows.has(e)||this._onRowClick(e,t),!this.onContextMenu||(this.onContextMenu(t),!1))),e.onDragStart=(t=>{this._onRowDrag(e,t)}),e.className=this._rowClassName,this._rows.push(e)}this.toggleRowSelection(null),this.onRowsChanged&&this.onRowsChanged(this._rows),this.renderRows()}renderRows(){for(;this.body.firstChild;)this.body.removeChild(this.body.firstChild);let e=document.createDocumentFragment();for(let t of this._rows)!this._showHidden&&t.hidden||e.appendChild(t.element);this.body.appendChild(e)}toggleRowSelection(e,t,i){let s,n=new Set(this._selectedRows);if(s=t?new Set(n):new Set,!i&&n.has(e)?s.delete(e):null!==e&&s.add(e),t&&i&&n.size>0){let t,i=this._rows.indexOf(e);for(let e of n){let s=this._rows.indexOf(e);(!t||Math.abs(s-i)<Math.abs(t-i))&&(t=s)}let r=Math.min(t,i)+1,a=Math.max(t,i),o=this._rows.slice(r,a);for(let e of o)!this._showHidden&&e.hidden||s.add(e)}this.selectedRows=s}}class se extends(X(K)){constructor(e,t){super(),this.name=e,this.path=t,this._link=null,this.className="crumb",this.onClick=null}static get type(){return"li"}get name(){return this._name||""}get path(){return this._path||[]}set name(e){this._name=e,this._link.innerText=this._name}set path(e){this._path=e}render(){super.render(),this._link=document.createElement("a"),this._link.href="#",this._link.onclick=(e=>{e.preventDefault(),this.onClick&&this.onClick(this.path)}),this._link.innerText=this.name,this.element.appendChild(this._link)}}class ne extends K{constructor(){super(),this.startCharacter="|",this.delimiter=">",this.onDragOver=null,this.className="crumbs",this.delimiterClassName="delimiter",this.onClick=null}static get type(){return"ul"}get path(){return this._path||[]}set delimiter(e){this._delimiter=e,this.render()}set path(e){this._path=e,this.render()}set startCharacter(e){this._startCharacter=e,this.render()}render(){super.render(),this.element.appendChild(this.buildDelimiter(this._startCharacter));for(let e=0;e<this.path.length;e++){let t=this.path.slice(0,e+1),i=this.path[e];0!==e&&this.element.appendChild(this.buildDelimiter(this._delimiter)),this.element.appendChild(this.buildCrumb(i,t))}}buildCrumb(e,t){let i=new se(e,t);return i.addDragoverAction(()=>{this.onDragOver&&this.onDragOver(i.path)}),i.onClick=(e=>{this.onClick&&this.onClick(e)}),i.element}buildDelimiter(e){let t=document.createElement("li");return t.className=this.delimiterClassName,t.innerText=e,t}push(e){this._path.push(e),this.path=this._path}pop(){let e=this._path.pop();return e&&(this.path=this._path),e}}class re extends K{constructor(e,t,i){super(),this._delay=i||null,this._errorClass="error",this.className="message",this.buttonClass="dialog-button delete",this.message=e,this.error=t||!1,this._delay&&window.setTimeout(()=>{this.remove()},this._delay)}static get type(){return"div"}get message(){return this._message}get error(){return this._error}set message(e){this._message=e,this._text.innerText=this._message}set error(e){this._error=Boolean(e),this._error?this.element.classList.add(this._errorClass):this.element.classList.remove(this._errorClass)}set buttonClass(e){this._deleteButton.className=e}render(){super.render(),this._text=document.createElement("span"),this._deleteButton=document.createElement("div"),this._deleteButton.onclick=(()=>{this.element.parentElement.removeChild(this.element)}),this._deleteButton.onclick=(e=>{e.preventDefault(),this.remove()}),this.element.appendChild(this._text),this.element.appendChild(this._deleteButton)}remove(){this.element.parentElement.removeChild(this.element)}}const ae='<svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="220" height="220" viewBox="0 0 440 440">  <path d="M170 423 c0 -38 -15 -46 -49 -29 -31 17 -32 16 -62 -13 -29 -30 -30\n-31 -13 -62 17 -34 9 -49 -28 -49 -26 0 -26 -100 0 -100 37 0 45 -15 28 -49\n-17 -31 -16 -32 13 -62 30 -29 31 -30 62 -13 34 17 49 9 49 -28 0 -26 100 -26\n100 0 0 37 15 45 49 28 31 -17 32 -16 62 13 29 30 30 31 13 62 -17 34 -9 49\n29 49 25 0 25 100 0 100 -38 0 -46 15 -29 49 17 31 16 32 -13 62 -30 29 -31\n30 -62 13 -34 -17 -49 -9 -49 29 0 25 -100 25 -100 0z m105 -148 c50 -49 15\n-135 -55 -135 -41 0 -80 39 -80 80 0 19 9 40 25 55 15 16 36 25 55 25 19 0 40\n-9 55 -25z"/>  <path d="M182 258 c-15 -15 -15 -61 0 -76 15 -15 61 -15 76 0 15 15 15 61 0\n76 -7 7 -24 12 -38 12 -14 0 -31 -5 -38 -12z"/></svg>',oe='<svg xmlns="http://www.w3.org/2000/svg" version="1.0" width="24pt" height="16pt" viewBox="0 0 24 16">  <path d="M 12,16 0,7 5.25,0.25 12,5.5 18,0.25 24,7 Z"/></svg>',le='<svg xmlns="http://www.w3.org/2000/svg" version="1.0" width="220" height="220" viewBox="0 0 440 440">  <path d="m 180,310 -40,56 C 116,396 86,422 74,426 30,438 2,410 14,366 18,354 44,324 74,300 l 56,-40 C 81.263674,188.193 104,100 160,50 220,-3 326,-4 380,60 c 53,62 59,175 1,229 C 320,346 225,354 180,310 Z M 340,100 C 247,-3 100,140 190,250 282,347 435,206 340,100 Z"/></svg>',he='<svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="220" height="220" viewBox="0 0 440 440">  <path d="M0 220 l0 190 220 0 220 0 0 -166 0 -165 -124 0 -125 0 -16 -28 c-15 -26 -20 -27 -96 -27 l-79 0 0 -190z"/></svg>',ce='<svg xmlns="http://www.w3.org/2000/svg" version="1.0" width="220" height="220" viewBox="0 0 440 440">  <path d="M 390,220 V 440 H 215 40 V 278 116 L 97,58 154,0 H 272 390 Z M 124,130 H 80 V 265 400 H 215 350 V 220 41 H 170 v 90 0 z"/></svg>';function de(e){let t={};try{let i=g(e).split("\n");for(let e of i){let i=e.split("=");2===i.length&&(t[i[0].trim()]=i[1].trim())}}catch(e){console.log(`Error parsing config file: ${e}`)}return t}async function ue(e,t){let i;i=t?de(t):{},Object.assign(i,e);let s="";for(let e in i)s+=`${e}=${i[e]}\n`;return b(s)}class me extends K{constructor(e,t){super(),this.searchPending=!1,this.messageRemovalDelay=null,this.maxNumMove=30,this.className="file-browser-container",this.actionsContainerClass="file-actions-container",this.tableContainerClass="file-browser-table-container",this.tableIconClass="icon",this.activeAjaxClass="ajax-active",this.searchInputClass="file-search-input",this.messageContainerClass="file-message-container",this.menuContainerClass="file-menu-container",this.searchContainerClass="file-search-container",this.stateManagerContainerClass="file-breadcrumbs-container",this.contextMenuClass="file-browser-context-menu",this.drowdownMenuButtonClass="dropdown-menu button",this.fileBrowserDialogClass="file-browser-dialog",this._dropdownMenuIcon=document.createElement("template"),this._dropdownMenuIcon.innerHTML=ae,this._dropdownMenuIcon.content.firstChild.classList.add(this.tableIconClass),this._carrotIcon=document.createElement("template"),this._carrotIcon.innerHTML=oe,this._carrotIcon.content.firstChild.classList.add(this.tableIconClass),this._carrotIcon.content.firstChild.classList.add("small"),this._searchIcon=document.createElement("template"),this._searchIcon.innerHTML=le,this._searchIcon.content.firstChild.classList.add(this.tableIconClass),this._folderIcon=document.createElement("template"),this._folderIcon.innerHTML=he,this._folderIcon.content.firstChild.classList.add(this.tableIconClass),this._documentIcon=document.createElement("template"),this._documentIcon.innerHTML=ce,this._documentIcon.content.firstChild.classList.add(this.tableIconClass),this.contextMenu=this.createContextMenu(),this.actionsContainer=document.createElement("div"),this.actionsContainer.className=this.actionsContainerClass,this.breadcrumbsContainer=this.createBreadcrumbs(),this.messagesContainer=this.createMessages(),this.menusContainer=this.createMenus(),this.breadcrumbsContainer=this.createBreadcrumbs(),this.searchContainer=this.createSearchElements(),this.tableContainer=this.createTableContainer(),this.actionsContainer.appendChild(this.breadcrumbsContainer),this.actionsContainer.appendChild(this.messagesContainer),this.actionsContainer.appendChild(this.menusContainer),this.actionsContainer.appendChild(this.searchContainer),this._element.appendChild(this.actionsContainer),this._element.appendChild(this.tableContainer),this.fileSystem=e,this.table=t,this.history=new ne}static get type(){return"div"}get columns(){return[new ee("",(e,t)=>{let i=document.createElement("div");i.className="selected-box",e.appendChild(i)},null,1),new ee("Id",(e,t)=>{e.innerText=t.id},null,2,!1),new ee("Name",(e,t)=>{let i,s;t.icon?((i=document.createElement("img")).width=22,i.height=22,i.className=this.tableIconClass,t.directory?i.src=t.icon:(i.src=t.icon,(s=document.createElement("img")).className="hover-image",s.style.display="none",i.onmouseover=(e=>{s&&(s.src=t.url),s.style.display="inline-block"}),i.onmouseout=(()=>{s.style.display="none"}))):i=t.directory?this._folderIcon.content.cloneNode(!0):this._documentIcon.content.cloneNode(!0),i.ondragstart=(()=>!1),e.appendChild(i),s&&e.appendChild(s);let n=document.createTextNode(t.name||"undefined");e.appendChild(n)},(e,t)=>d(e.name,t.name),8),new ee("Size",(e,t)=>{if(t.directory)e.innerText="---";else{let i,s=t.size;s&&(i=c(s)),e.innerText=i||"---"}},(e,t)=>u(e.size,t.size),2),new ee("Last Modified",(e,t)=>{e.innerText=new Date(t.lastModified).toLocaleString()},(e,t)=>m(e.lastModified,t.lastModified),4),new ee("Created",(e,t)=>{e.innerText=new Date(t.created).toLocaleString()},(e,t)=>m(e.created,t.created),4),new ee("Type",(e,t)=>{e.innerText=t.mimeType},(e,t)=>m(e.mimeType,t.mimeType),4,!1)]}get table(){return this._table}get fileSystem(){return this._fileSystem}get history(){return this._history}set table(e){this._table&&this.tableContainer.removeChild(this._table.element),this._table=e,this.syncTable(),this.tableContainer.appendChild(this._table.element)}set fileSystem(e){this._fileSystem=e,this.syncFileSystem()}set history(e){this._history&&this.actionsContainer.removeChild(this._history.element),this._history=e,this.syncHistory(),this.breadcrumbsContainer.appendChild(this._history.element)}clone(){return new this.constructor(this.fileSystem.clone(),this.table.clone())}syncFileSystemAndHistory(){this.fileSystem&&this.history&&(this.history.path=this.fileSystem.path,this.fileSystem.onPathChanged=(e=>{this.history.path=e}))}syncFileSystemAndTable(){this.fileSystem&&this.table&&(this.setTableData(Object.values(this.fileSystem.data)),this.fileSystem.onDataChanged=(e=>{this.setTableData(Object.values(e))}),this.table.onDrop=(e=>{this.handleDataTransfer(e.dataTransfer)}))}syncFileSystem(){this.fileSystem&&(this.syncFileSystemAndHistory(),this.syncFileSystemAndTable())}syncHistory(){this.history&&(this.history.onClick=(e=>{this.goTo(e,!0)}),this.history.onDragOver=(e=>{this.goTo(e,!0)}),this.syncFileSystemAndHistory())}syncTable(){this.table&&(this.table.columns=this.columns,this.table.onRowDblClick=((e,t)=>{if(e.data.directory)this.goTo([e.data.name]);else if(e.data.url.startsWith("data")){let t=document.createElement("a");t.href=e.data.url,t.setAttribute("download",e.data.name),t.click()}else window.open(e.data.url)}),this.table.onContextMenu=(e=>{this.showContextMenu(e.pageX,e.pageY)}),this.table.onRowsChanged=(e=>{for(let t of e)this.initializeNewRow(t)}),this.syncFileSystemAndTable())}async loadingWrapper(e){this.element.classList.add(this.activeAjaxClass);try{return await e}finally{this.element.classList.remove(this.activeAjaxClass)}}async errorLoggingWrapper(e){try{return await e}catch(e){this.addMessage(e,!0)}}logAndLoadWrapper(e){return this.loadingWrapper(this.errorLoggingWrapper(e))}createContextMenu(){let e=new Y;return e.name="Settings",e.element.classList.add(this.contextMenuClass),e}createSearchElements(){let e=document.createElement("input");e.className=this.searchInputClass,e.placeholder="Search",e.oninput=(()=>{this.searchPending||(this.searchPending=!0,setTimeout(()=>{this.search(e.value),this.searchPending=!1},500))}),e.onkeyup=(t=>{this.searchPending||"Enter"!==t.key||this.search(e.value)});let t=document.createElement("div");return t.className=this.searchContainerClass,t.appendChild(this._searchIcon.content.cloneNode(!0)),t.appendChild(e),t}createMenus(){let e=document.createElement("div");e.className=this.menuContainerClass;let t=document.createElement("div");return t.className=this.drowdownMenuButtonClass,t.appendChild(this._dropdownMenuIcon.content.cloneNode(!0)),t.appendChild(this._carrotIcon.content.cloneNode(!0)),t.onclick=(e=>{e.stopPropagation();let i=t.getBoundingClientRect(),s=document.documentElement.scrollLeft,n=document.documentElement.scrollTop;this.showContextMenu(i.left+s,i.bottom+n)}),e.appendChild(t),e}createMessages(){let e=document.createElement("div");return e.className=this.messageContainerClass,e}createTableContainer(){let e=document.createElement("div");return e.className=this.tableContainerClass,e}createBreadcrumbs(){let e=document.createElement("div");return e.className=this.stateManagerContainerClass,e}initializeNewRow(e){e.hidden=e.data.name.startsWith("."),e.data.directory&&e.addDragoverAction(()=>{this.goTo([e.data.name])})}async handleDataTransfer(e){this.clearMessages();let t=[];for(let i of e.files)t.push(this.fileSystem.addFile(this.fileSystem.path,i,i.name));let i=e.getData("text/uri-list");if(i){let e=i.split("\n");if(e.length.length>this.maxNumMove)alert(`Cannot move more than ${this.maxNumMove} items.`);else for(let i=0;i<e.length;i++){let s=e[i];if(!s.startsWith("#")){let e=s.split("/");e.length>0&&e[e.length-1].length<255?t.push(this.fileSystem.addFile(this.fileSystem.path,s,e[e.length-1])):t.push(this.fileSystem.addFile(this.fileSystem.path,s,"unknown"))}}}this.logAndLoadWrapper(Promise.all(t));let s=e.getData(this._table.dataTransferType);if(s){let e=JSON.parse(s),t=[],i=[];for(let s of e)this.fileSystem.data[s.name]||(i.push(s),t.push(s.name));if(i.length>this.maxNumMove)alert(`Cannot move more than ${this.maxNumMove} items.`);else if(i.length>0){let i=new Q;i.name="Confirm Move",i.onClose=(()=>{i.remove()});let s=document.createElement("div");s.innerText=`Are you sure you want to move ${t.join(", ")}?`,i.onConfirmed=(()=>{let t=[];for(let i of e){let e=async e=>{let t=await this.fileSystem.getFileObject(e.path);return await this.fileSystem.move(this.fileSystem.path,t)};t.push(e(i))}this.logAndLoadWrapper(Promise.all(t)),this.contextMenu.close()}),i.items=[s],i.show()}}}async search(e){if(this.clearMessages(),e)try{let t=await this.loadingWrapper(this.fileSystem.search(this.fileSystem.path,e));this.setTableData(t);let i=[this.history.baseName].concat(this.fileSystem.path).join("/");this.addMessage(`${t.length} search results for "${e}" in ${i}.`)}catch(e){this.addMessage(e,!0)}else this.setTableData(Object.values(this.fileSystem.data))}fileObjectToTableData(e){return{id:e.id,path:e.path,name:e.name,directory:e.directory,url:e.url,icon:e.icon,mimeType:e.mimeType,lastModified:e.lastModified,created:e.created,size:e.size}}setTableData(e){let t=[];for(let i of e)t.push(this.fileObjectToTableData(i));this.table.data=t}showContextMenu(e,t){let i=this._table.selectedData;this.contextMenu.items=this.getMenuItems(i),this.contextMenu.move(e,t),this.contextMenu.show()}getMenuItems(e){let t=[];if(e.size>0){if(1===e.size){let i=e.values().next().value,s=document.createElement("div");if(s.innerText="Open",s.onclick=(()=>{i.directory?this.goTo([i.name]):window.open(i.url),this.contextMenu.close()}),t.push(s),i.url){let e=document.createElement("div");e.innerText="Copy Url",e.onclick=(()=>{let t=document.createElement("textarea");e.appendChild(t),t.innerText=i.url,t.select(),document.execCommand("copy"),e.removeChild(t)}),t.push(e)}let n=document.createElement("div");if(n.innerText="Rename",n.onclick=(()=>{this.logAndLoadWrapper((async()=>{let e=prompt("New Name");if(null!==e){this.contextMenu.close();let t=await this.fileSystem.getFileObject(i.path);await t.rename(e),await this.fileSystem.refresh()}})())}),t.push(n),"application/javascript"===i.mimeType){let e=document.createElement("div");e.innerText="Run",e.onclick=(()=>{this.errorLoggingWrapper((async()=>{let e=await this.fileSystem.getFileObject(i.path);this.fileSystem.execFileObject(e)})())}),t.push(e)}}let i=document.createElement("div");if(i.innerText="Delete",i.onclick=(()=>{event.preventDefault(),event.stopPropagation();let t=new Q(this.contextMenu);t.onClose=(()=>{t.remove()});let i=document.createElement("div"),s=[];for(let t of e)s.push(t.name);i.innerText=`Are you sure you want to remove ${s.join(", ")}?`;let n=[];t.onConfirmed=(()=>{this.logAndLoadWrapper((async()=>{for(let t of e){let e=await this.fileSystem.getFileObject(t.path);n.push(e.delete())}this.contextMenu.close(),await Promise.all(n),await this.fileSystem.refresh()})())}),t.items=[i],t.show()}),t.push(i),e.size<=30){let i=document.createElement("div");i.innerText="Move",i.onclick=(t=>{t.preventDefault(),t.stopPropagation();let i=new pe(this.fileSystem.clone(),this.table.clone());i.table.selectMultiple=!1,i.dialog.parent=this.contextMenu,i.dialog.name="Move Files",i.dialog.element.classList.add(this.fileBrowserDialogClass),i.dialog.confirmationText="Select",i.dialog.onConfirmed=(()=>{this.logAndLoadWrapper((async()=>{let t=i.fileSystem.path;if(1===i.table.selectedData.size){let e=i.table.selectedData.values().next().value.name;t.push(e)}let s=[];for(let n of e){let e=await i.fileSystem.getFileObject(n.path);s.push(i.fileSystem.move(t,e))}await Promise.all(s),await this.fileSystem.refresh()})())}),i.dialog.onClose=(e=>{i.dialog.remove()}),i.dialog.onRemove=(()=>{i.contextMenu.remove()}),i.dialog.show()}),t.push(i)}}let i=document.createElement("div");i.innerText="Add File",i.onclick=(e=>{e.preventDefault(),e.stopPropagation();let t=new Q(this.contextMenu);t.name="Add File",t.confirmationText="Add";let i=document.createElement("div"),s=document.createElement("span");s.innerText="File";let n=document.createElement("input");n.type="file",i.appendChild(s),i.appendChild(n),t.onConfirmed=(()=>{this.logAndLoadWrapper((async()=>{let e=[];for(let t of n.files)e.push(this.fileSystem.addFile(this.fileSystem.path,t));this.contextMenu.close(),await Promise.all(e)})())}),t.items=[i],t.show()}),t.push(i);let s=document.createElement("div");s.innerText="Add Directory",s.onclick=(()=>{let e=prompt("Directory Name");null!==e&&this.logAndLoadWrapper(this.fileSystem.addDirectory(this.fileSystem.path,e)),this.contextMenu.close()}),t.push(s);let n=document.createElement("div"),r=document.createElement("span"),a=document.createElement("input");a.type="checkbox",a.checked=this.table.showHidden,r.innerText="Show Hidden",a.onchange=(()=>{this.table.showHidden=a.checked}),n.appendChild(r),n.appendChild(a),t.push(n);let o=document.createElement("div");return o.innerText="Visible Columns",o.onclick=(e=>{e.preventDefault(),e.stopPropagation(),this.table.visibleColumnsDialog.show()}),t.push(o),t}addMessage(e,t){let i;console.log(e),i=e instanceof Error?new re(e.message,!0,this.messageRemovalDelay):new re(e.toString(),t,this.messageRemovalDelay),this.messagesContainer.appendChild(i.element)}clearMessages(){for(;this.messagesContainer.firstChild;)this.messagesContainer.removeChild(this.messagesContainer.firstChild)}goTo(e,t){t||(e=this.fileSystem.path.concat(e)),this.clearMessages(),this.element.classList.remove(this.dragOverClass),this.logAndLoadWrapper(this.fileSystem.changeDirectory(e))}}class pe extends me{constructor(e,t,i){i=i||new Q,super(e,t),this._dialog=i,this.contextMenu.parent=this._dialog,this.table.visibleColumnsDialog.parent=this._dialog,this._dialog.items=[this.element]}get dialog(){return this._dialog}}let fe=e=>(class extends e{constructor(...e){super(...e),this.logAndLoadWrapper(this.getConfig().then(e=>{try{this.config=e}catch(e){console.log(`Error setting browser config: ${e}`)}}))}static get localConfigPath(){return[".config","browser"]}static get sharedConfigPath(){return["Files",".config","browser"]}static get configPaths(){return[this.sharedConfigPath,this.localConfigPath]}set config(e){let t=e.visibleColumns;if(t){let e=t.split(",");for(let t of this.table.columns)t.visible=e.includes(t.name)}let i=e.defaultSortColumn;if(i){let e=!1;i.startsWith("-")&&(e=!0,i=i.slice(1));for(let t of this.table.columns)if(t.name===i){let i;i=t.sortCompare&&e?(...e)=>-t.sortCompare(...e):t.sortCompare,this.table.defaultSortFunc=i,this.setTableData(Object.values(this.fileSystem.data))}}}syncTable(){if(super.syncTable(),this.table)for(let e of this.table.columns){let t=e.onVisibilityChange;e.onVisibilityChange=(e=>{t(e);let i=[];for(let e of this.table.columns)e.visible&&i.push(e.name);this.addLocalConfig({visibleColumns:i.join(",")}).then().catch(e=>{console.log(`Error adding config: ${e}`)})})}}async addLocalConfigFile(){let e=this.constructor.localConfigPath.slice(),t=e.pop(),i=[];for(;e.length>0;){i.push(e.shift());try{await this.fileSystem.getFileObject(i)}catch(e){if(!(e instanceof F))throw e;await this.fileSystem.addDirectory(i.slice(0,i.length-1),i[i.length-1])}}await this.fileSystem.addFile(i,new File([""],t,{type:"text/plain"}),t)}async addLocalConfig(e){let t;try{let i=await this.fileSystem.getFileObject(this.constructor.localConfigPath);t=ue(e,await i.read())}catch(e){e instanceof F&&await this.fileSystem.waitOn(this.addLocalConfigFile.bind(this))(),t=ue({})}try{await this.fileSystem.write(this.constructor.localConfigPath,t)}catch(e){e instanceof F&&await this.fileSystem.write(this.constructor.localConfigPath,t)}}async getConfig(){let e={},t=this.constructor.configPaths.slice();for(;t.length>0;){let i,s=t.shift();try{let e=await this.fileSystem.getFileObject(s);i=de(await e.read())}catch(e){console.log(`Could not get config file at /${s.join("/")}: ${e}`),i={}}Object.assign(e,i)}return e}});async function ge(e){return alert(e),e}let we=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];async function ye(e){let t=this.path.slice(),i=0,s={};for(let e in this.data){let t=this.data[e];if(!t.directory){let e=new Date(t.created).getMonth(),i=we[e],n=s[i]||[];n.push(t),s[i]=n}}for(let e in s){this.data.hasOwnProperty(e)||await this.addDirectory(this.path,!0,e),await this.changeDirectory([e]);let n=s[e];for(let e of n)i++,await this.move(e.id);await this.changeDirectory(t,!0)}return`${i} files archived`}async function _e(e){this.trackState=!0;let t,i=document.getElementById(e),s=new ie;if(s.selectMultiple=!0,i){t=new(fe(me))(this,s),i.appendChild(t.element)}else{(t=new(fe(pe))(this,s,new Y)).dialog.show()}return t.element.id="FB"+Math.random().toString(36).split(".")[1],`New browser created with id=${t.element.id}`}async function Ce(e){let t=e.split("/");""!==t[0]&&(t=this.path.concat(t)),await this.changeDirectory(t)}async function be(e){let t=await this.search(e),i=[];for(let e of t)i.push(e.name);return i.join("\n")}async function ve(e){let t=[];for(let e in this.data)t.push(e);return t.sort(),t.join("\n")}class Se extends K{constructor(e){super(),this._fileSystem=e,this._maxLines=20,this._pathDelimiter="/",this._lineSplitter="$",this.className="terminal",this.element.contentEditable=!0,this.element.onkeydown=(e=>{if(this.moveCursorToEnd(),"Backspace"===e.key){let t=this.lines;t[t.length-1]===this.startText&&e.preventDefault()}else"Enter"===e.key&&(e.preventDefault(),this.execute())}),this.element.innerText=this.startText,this.onClose=null}get startText(){return this.pathString+this._lineSplitter}get pathString(){return this._pathDelimiter+this._fileSystem.path.join(this._pathDelimiter)}get lines(){return this.element.innerText.split("\n")}set lines(e){e.push(this.startText);let t=Math.max(0,e.length-this._maxLines);this.element.innerText=e.slice(t).join("\n"),this.moveCursorToEnd()}async execute(){let e=this.lines,t=e[e.length-1].toString().split(this._lineSplitter),i=t[t.length-1].split(/[\s]+/),s=i.shift();if(s)if("exit"===s&&this.onClose)this.onClose();else{let t;try{t=await this._fileSystem.exec(s,...i)}catch(e){t=e.message}t&&(e=e.concat(t.toString().split("\n")))}this.lines=e}moveCursorToEnd(){let e=document.createRange();e.selectNodeContents(this.element),e.collapse(!1);let t=window.getSelection();t.removeAllRanges(),t.addRange(e)}refreshText(){this.element.innerText=this.startText,this.moveCursorToEnd()}}class Fe extends Y{constructor(e){super(),this._terminal=new Se(e),this.items=[this._terminal.element],this._pressedKeys=new Set,document.onkeydown=(e=>{this._pressedKeys.add(e.key.toLowerCase()),this.shouldOpen(e)&&(this.show(),this._terminal.refreshText())}),this._terminal.onClose=(()=>{this.close()})}shouldOpen(e){return e.ctrlKey&&"y"===e.key}}async function Ne(){let e=new Fe(this);return e.element.id="TR"+Math.random().toString(36).split(".")[1],e.show(),`New terminal created with id=${e.element.id}`}async function De(...e){let t=S(...e);e=t[0];let i=t[1];return i.type||(i.type="fileapi"),await this.exec(`mount.${i.type}`,...e)}async function xe(e,t){let i=await this.getFileObject(this.path,!1);return this.mount(i,new x(e),t),await this.refresh(),`New FileAPI mount created at ${i}`}class Te{constructor(e,t,i){this._email=e,this._password=t,this._apiKey=i,this._authToken=null}static get url(){return new URL("https://www.photoshelter.com")}async _getAuthToken(){if(null===this._authToken){let e=this.constructor.url;e.pathname="/psapi/v3/mem/authenticate",e.searchParams.set("api_key",this._apiKey);let t={email:this._email,password:this._password,mode:"token"},i=await fetch(e.toString(),{body:JSON.stringify(t),method:"POST"});if(!i.ok)throw Error("Error authentication Photoshelter");{let e=i.json().data;if(this._authToken=e.token,e.hasOwnProperty("org")){let t=this.constructor.url;if(t.pathname=`/psapi/v3/mem/organization/${e.org[0].id}/authenticate`,!(await fetch(t.toString(),{headers:await this.getHeaders(),method:"POST"})).ok)throw Error("Error authentication Photoshelter organization")}}}return this._authToken}async getHeaders(){return{"X-PS-Api-Key":this._apiKey,"X-PS-Auth-Token":await this._getAuthToken()}}async _get(e,t){t=void 0===t||t;let i=await fetch(e.toString(),{headers:await this.getHeaders()});if(!i.ok){if(t)return this._authToken=null,await this._get(e,!1);throw new Error("Photoshelter error: "+i.statusText)}return i}async _post(e,t,i){i=void 0===i||i;let s=await this.getHeaders();s["Content-Type"]="application/json";let n=await fetch(e.toString(),{headers:s,body:t,method:"POST"});if(!n.ok){if(i)return this._authToken=null,await this._post(e,t,!1);throw new Error("Photoshelter error: "+n.statusText)}return n}async getImageFile(e){let t=this.constructor.url;t.pathname=`/psapi/v3/mem/image/${e}/download`,t.searchParams.set("f_embed","");let i=await this._get(t.toString()),s=i.headers.get("content-disposition"),n=await i.blob();return new File([n],s,{type:n.type,lastModified:Date.now()})}async getImageData(e){let t=this.constructor.url;return t.pathname=`/psapi/v3/mem/image/${e}`,(await this._get(t.toString())).json().data.image}async getImageGalleries(e){e=e||"root";let t=this.constructor.url;return t.pathname=`/psapi/v3/mem/image/${e}/galleries`,t.searchParams.set("extend",JSON.stringify({Gallery:{}})),(await this._get(t.toString())).json().data.ImageGallery}async getImageLink(e){let t=this.constructor.url;return t.pathname=`/psapi/v3/mem/image/${e}/link`,(await this._get(t.toString())).json().data.ImageLink.link}async getCollectionData(e){e=e||"root";let t=this.constructor.url;return t.pathname=`/psapi/v3/mem/collection/${e}`,(await this._get(t.toString())).json().data.Collection}async getCollectionParent(e){e=e||"root";let t=this.constructor.url;return t.pathname=`/psapi/v3/mem/collection/${e}/parent`,(await this._get(t.toString())).json().data.Collection}async getCollectionChildren(e){e=e||"root";let t=this.constructor.url;return t.pathname=`/psapi/v3/mem/collection/${e}/children`,t.searchParams.set("extend",JSON.stringify({Collection:{},Gallery:{}})),(await this._get(t.toString())).json().data.Children}async getGalleryData(e){e=e||"root";let t=this.constructor.url;return t.pathname=`/psapi/v3/mem/gallery/${e}`,(await this._get(t.toString())).json().data.Gallery}async getGalleryParent(e){e=e||"root";let t=this.constructor.url;return t.pathname=`/psapi/v3/mem/gallery/${e}/parent`,t.searchParams.set("extend",JSON.stringify({Collection:{}})),(await this._get(t.toString())).json().data.Parents}async getGalleryChildren(e){e=e||"root";let t=this.constructor.url;return t.pathname=`/psapi/v3/mem/gallery/${e}/children`,t.searchParams.set("extend",JSON.stringify({Image:{},ImageLink:{}})),(await this._get(t.toString())).json().data.GalleryImage}async search(e){let t=this.constructor.url;t.pathname="/psapi/v3/mem/image/search";let i=e.split(" ");return t.searchParams.set("terms",JSON.stringify(i)),t.searchParams.set("extend",JSON.stringify({Image:{},ImageLink:{}})),(await this._get(t.toString())).json().data.Results}}class Oe extends N{constructor(e,t,i,s){super(),this._photoshelterAPI=new Te(e,t,i)}async addDirectory(e,t){}async addFile(e,t,i){}clone(){}async copy(e,t){}async delete(e){}async move(e,t){}_dataToImageFileNode(e){let t;t=e.hasOwnProperty("ImageLink")?e.ImageLink.link:this._photoshelterAPI.getImageLink(fileNode.id);let i=(new Date).toISOString();return{id:e.image_id,name:e.file_name,directory:!1,icon:null,url:t,size:e.file_size,mimeType:"application/octet-stream",created:i,lastModified:i}}_dataToCollectionFileNode(e){return{id:e.collection_id,name:e.name,directory:!0,url:"",icon:null,size:0,mimeType:"application/json",lastModified:new Date(e.modified_at),created:new Date(e.created_at)}}_dataToGalleryFileNode(e){return{id:e.gallery_id,name:e.name,directory:!0,url:"",icon:null,size:0,mimeType:"application/json",lastModified:new Date(e.modified_at),created:new Date(e.created_at)}}async readFileNode(e,t){if(e.startsWith("I"))return await this._photoshelterAPI.getImageFile(e);let i={};if(e===(await this.getRootFileNode()).id||e.startsWith("C")){let t=await this._photoshelterAPI.getCollectionChildren(e),s=t.Collection||[],n=t.Gallery||[];for(let e of s)i[e.name]=this._dataToCollectionFileNode(e);for(let e of n)i[e.name]=this._dataToGalleryFileNode(e)}else if(e.startsWith("G")){let t=await this._photoshelterAPI.getGalleryChildren(e);for(let e of t)i[e.file_name]=this._dataToImageFileNode(e)}return new Blob([JSON.stringify(i)],{type:"application/json"})}async rename(e,t){}async getRootFileNode(){let e=this._photoshelterAPI.getCollectionData();return this._dataToCollectionFileNode(e)}async search(e,t){}async writeFileNode(e,t){}}async function Ee(e,t,i,s){let n=await this.getFileObject(this.path,!1),r=new Oe(e,t,i);return this.mount(n,r,s),await this.refresh(),`New Photoshelter mount created at ${n}`}i.d(t,"fileSystem",function(){return Me}),i.d(t,"FileSystem",function(){return V});let je=new k,Me=new V(je);(async function(){let e=await Me.getRootFileObject();Me._binFuncs={};let t=new j,i=await t.getRootFileNode();function h(e,s){Me._binFuncs[e]=s;let n=`let main = async (...args) => {return await this._binFuncs["${e}"].bind(this)(...args);}`,r=`${e}.js`;t.addFile(i.id,b(n),r,"application/javascript")}h("alert",ge),h("archive",ye),h("browser",_e),h("cd",Ce),h("find",be),h("ls",ve),h("terminal",Ne),h("mount",De),h("mount.fileapi",xe),h("mount.photoshelter",Ee),Me.mount(e,t,"bin"),Me._modules={};let c=new j,d=await c.getRootFileNode();function u(e,t){Me._modules[e]=t;let i="";for(let s in t)i+=`let ${s} = this._modules["${e}"]["${s}"];`;let s=`${e}.js`;c.addFile(d.id,b(i),s,"application/javascript")}u("browser",l),u("config",o),u("dialog",n),u("messages",a),u("table",r),u("storage",{local:k,memory:j,remote:x,node:I}),u("utils",s),Me.mount(e,c,"api"),await Me.refresh()})().catch(e=>{console.log(e),ge("Error setting up file system: "+e)});t.default=Me}]).default);