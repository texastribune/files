<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: files/storages/node.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: files/storages/node.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {AbstractFileStorage} from "./base.js";
import {stringToArrayBuffer} from "../../utils.js";
import * as fs from 'fs';
import * as path from 'path';


function nodeFSFuncAsyncWrapper(func) {
    return async (...args) => {
        return await new Promise((resolve, reject) => {
            let callback = (err, stats) => {
                if (err) {
                    reject(err)
                } else {
                    resolve(stats);
                }
            };
            args.push(callback);
            func(...args);
        })
    }
}


/**
 * A storage class that stores file on the local system using NodeJS file operations.
 *  @extends AbstractFileStorage
 */
export class NodeFileStorage extends AbstractFileStorage {
    constructor(rootPath) {
        super();

        this.rootPath = rootPath || '/';

        this.stat = nodeFSFuncAsyncWrapper(fs.stat);
        this.readFile = nodeFSFuncAsyncWrapper(fs.readFile);
        this.writeFile = nodeFSFuncAsyncWrapper(fs.writeFile);
        this.readdir = nodeFSFuncAsyncWrapper(fs.readdir);
        this.appendFile = nodeFSFuncAsyncWrapper(fs.appendFile);
        this.mkdir = nodeFSFuncAsyncWrapper(fs.mkdir);
        this.fsrename = nodeFSFuncAsyncWrapper(fs.rename);
        this.unlink = nodeFSFuncAsyncWrapper(fs.unlink);
    }

    static get preservesMimeType(){
        return false;
    }

    async _getFileNodeFromFSPath(fsPath) {
        let stat = await this.stat(fsPath);
        let name = path.basename(fsPath);
        let directory = stat.isDirectory();
        return {
            id: fsPath,
            name: name,
            directory: stat.isDirectory(),
            mimeType: directory ? 'application/json' : 'application/octet-stream',
            size: stat.size,
            created: stat.birthtime.toISOString(),
            lastModified: stat.ctime.toISOString(),
            icon: null,
            hidden: name.startsWith('.')
        }
    }

    async getRootFileNode() {
        return await this._getFileNodeFromFSPath(this.rootPath);
    }

    async readFileNode(id, params) {
        let fileNode = await this._getFileNodeFromFSPath(id);
        if (fileNode.directory) {
            let childNodes = [];
            let nameArray = await this.readdir(id);
            for (let name of nameArray) {
                let childNode = await this._getFileNodeFromFSPath(path.join(id, name));
                childNodes.push(childNode);
            }
            return stringToArrayBuffer(JSON.stringify(childNodes));
        }
        let typedArray = await this.readFile(id);
        return typedArray.buffer;
    }

    async writeFileNode(id, data) {
        await this.writeFile(id, data);
    }

    async addFile(parentId, fileData, filename, type) {
        if (!(fileData instanceof ArrayBuffer)) {
            throw new Error(`File data must be ArrayBuffer not ${typeof fileData}.`)
        }
        let filePath = path.join(parentId, filename);
        await this.appendFile(filePath, fileData);
        return await this._getFileNodeFromFSPath(filePath);
    }

    async addDirectory(parentId, name) {
        let dirPath = path.join(parentId, name);
        await this.mkdir(dirPath, null);
        return await this._getFileNodeFromFSPath(dirPath);
    }

    async rename(id, newName) {
        let dirName = path.dirname(id);
        await this.fsrename(id, path.join(dirName, newName));
    }

    async delete(id) {
        await this.unlink(id);
    }

    async copy(sourceId, targetParentId) {
        throw new Error("Not implemented")
    }

    async move(sourceId, targetParentId) {
        throw new Error("Not implemented")
    }

    async search(id, query) {
        throw new Error("Not implemented")
    }

    clone() {
        throw new Error("Not implemented")
    };
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-utils.html">utils</a></li></ul><h3>Classes</h3><ul><li><a href="AbstractFileStorage.html">AbstractFileStorage</a></li><li><a href="BaseFileSystem.html">BaseFileSystem</a></li><li><a href="BreadCrumb.html">BreadCrumb</a></li><li><a href="Column.html">Column</a></li><li><a href="DialogBrowser_DialogBrowser.html">DialogBrowser</a></li><li><a href="Element.html">Element</a></li><li><a href="FileAPIFileStorage.html">FileAPIFileStorage</a></li><li><a href="FileBrowser_FileBrowser.html">FileBrowser</a></li><li><a href="FileObject_FileObject.html">FileObject</a></li><li><a href="FileSystem.html">FileSystem</a></li><li><a href="Link_Link.html">Link</a></li><li><a href="LocalStorageFileStorage.html">LocalStorageFileStorage</a></li><li><a href="MemoryFileStorage.html">MemoryFileStorage</a></li><li><a href="NodeFileStorage.html">NodeFileStorage</a></li><li><a href="PhotoshelterStorage.html">PhotoshelterStorage</a></li><li><a href="Row.html">Row</a></li><li><a href="Table.html">Table</a></li></ul><h3>Mixins</h3><ul><li><a href="CacheMixin.html">CacheMixin</a></li><li><a href="DraggableMixin.html">DraggableMixin</a></li><li><a href="DroppableMixin.html">DroppableMixin</a></li><li><a href="ExecutableMixin.html">ExecutableMixin</a></li><li><a href="HiddenFileAPIMixin.html">HiddenFileAPIMixin</a></li><li><a href="HiddenReferenceLinkMixin.html">HiddenReferenceLinkMixin</a></li><li><a href="MountStorageMixin.html">MountStorageMixin</a></li><li><a href="StateMixin.html">StateMixin</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-DeveloperTutorial.html">Developers</a></li><li><a href="tutorial-UserInterfaceTutorial.html">User Interface</a></li></ul><h3>Global</h3><ul><li><a href="global.html#parseConfigFile">parseConfigFile</a></li><li><a href="global.html#updateConfigFile">updateConfigFile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
